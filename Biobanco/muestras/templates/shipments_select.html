{% extends 'base.html'%}

{% block content  %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enviar Muestras</title>
    <style>
        
        .submit-button {
            background-color: #4F709C;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        
        .submit-button:hover {
            background-color: #3A5677;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f8f8;
            padding: 20px;
        }
        h1, h2 {
            margin-bottom: 20px;
        }
        .filter-box, .samples-selection, .samples-to-send {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        button {
            background-color: #4F709C;
            color: white;
            padding: 10px 20px; /* Aumentar el padding horizontal para hacer el botón más grande */
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold; /* Agregar negrita para mayor énfasis */
            transition: background-color 0.3s ease; /* Agregar transición al color de fondo */
        }
        button:hover {
            background-color: #3A5677; /* Cambiar color de fondo al pasar el mouse */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #4F709C;
            color: white;
        }
    </style>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <h1>Enviar Muestras</h1>
    
    <!-- Formulario de Filtro -->
    <div class="filter-box">
        <form id="filter-form" method="POST" action="{% url 'shipments_select' %}">
            {% csrf_token %}
            <!-- Campos de filtro -->
            <label for="year">Año:</label>
            <input type="number" id="year" name="year">
            
            <label for="month">Mes:</label>
            <input type="number" id="month" name="month" min="1" max="12">
            
            <label for="subject_id">ID Sujeto:</label>
            <input type="text" id="subject_id" name="subject_id">
            
            <label for="volume_condition">Volumen:</label>
            <select id="volume_condition" name="volume_condition">
                <option value="greater">Mayor a</option>
                <option value="less">Menor a</option>
                <option value="equal">Igual a</option>
            </select>
            <input type="number" id="volume" name="volume" min="0"> ml
            <input type="hidden" id="selected-samples" name="selected_samples" value="">
            
            <input type="submit" value="Buscar" name="filter_action">
        </form>
    </div>
    
    <div class="samples-selection">
        <h2>Seleccionar Muestras</h2>
        <table id="samplesTable">
            <thead>
                <tr>
                    <th>ID Sujeto</th>
                    <th>Fecha</th>
                    <th>Número de Muestra</th>
                    <th>Volumen</th>
                    <th>Estado de Preservación</th>
                    <th>Freezer</th>
                    <th>Rack</th>
                    <th>Caja</th>
                    <th>Celda</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for sample in samples %}
                {% if sample.SHIPMENT_id_shipment == 0 %}
                <tr data-sample-id="{{ sample.id_sample }}" {% if sample.id_sample in selected_samples %}class="selected"{% endif %}>
                    <td>{{ sample.id_subject }}</td>
                    <td>{{ sample.date_sample }}</td>
                    <td>{{ sample.id_sample }}</td>
                    <td>{{ sample.ml_volume }}</td>
                    <td class="preservation-display"> {% if sample.state_preservation %}Descongelado{% else %}Normal{% endif %} </td>
                    <td class="freezer-display"> {{ sample.freezer_name }} </td>
                    <td class="rack-display">{{ sample.rack_name }} </td>
                    <td class="box-display"> {{ sample.box_name }}  </td>
                    <td class="cell-display"> {{ sample.location_set.first.cell }} </td>
                    <td> <button class="add-to-send" type="button">Agregar a Envíos</button> </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Dentro de tu formulario en la sección de Muestras a Enviar -->
    <div class="samples-to-send">
        <h2>Muestras a Enviar</h2>
        <form id="send-form" method="POST" action="{% url 'shipments_select' %}">
            {% csrf_token %}
            <table id="sendTable">
                <thead>
                    <tr>
                        <th>ID Sujeto</th>
                        <th>Fecha</th>
                        <th>Número de Muestra</th>
                        <th>Volumen</th>
                        <th>Estado de Preservación</th>
                        <th>Freezer</th>
                        <th>Rack</th>
                        <th>Caja</th>
                        <th>Celda</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Las filas aquí serán añadidas dinámicamente con JavaScript -->
                </tbody>
            </table>
            <input type="submit" value="Registrar Envío" name="register_action" class="submit-button">
        </form>
    </div>
    
    <script>
        // Define la variable csrf_token con el valor del token CSRF
        var csrf_token = "{{ csrf_token }}";
    
        // Manejar el envío del formulario de envío
        document.getElementById('send-form').addEventListener('submit', function(event) {
            event.preventDefault();
            let selectedSamples = Array.from(document.querySelectorAll('#sendTable tbody tr')).map(row => row.getAttribute('data-sample-id'));
            if (selectedSamples.length === 0) {
                Swal.fire('Error', 'No se han seleccionado muestras para enviar.', 'error');
            } else {
                let message = 'Muestras seleccionadas: ' + selectedSamples.join(', ') + '. ¿Está todo correcto?';
                Swal.fire({
                    title: '¿Seguro que todo está bien?',
                    text: message,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sí, enviar',
                    cancelButtonText: 'No, revisar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Agregar console.log para depuración
                        console.log('Enviando formulario...');
                        event.target.submit();
                    }
                });
            }
        });
    
        function moveRow(sampleId, targetTableId, buttonText, buttonClass) {
            let sourceRow = document.querySelector(`tr[data-sample-id="${sampleId}"]`);
            if (!sourceRow) return;
        
            let newRow = sourceRow.cloneNode(true);
            let button = newRow.querySelector('button');
            button.textContent = buttonText;
            button.className = buttonClass;
        
            document.getElementById(targetTableId).querySelector('tbody').appendChild(newRow);
            sourceRow.remove();
        
            if (targetTableId === 'sendTable') {
                addHiddenInput(sampleId); // Agregar input oculto al formulario
            } else {
                removeHiddenInput(sampleId); // Eliminar input oculto del formulario
            }
        
            // Actualizar el campo oculto selected_samples con las muestras seleccionadas
            let selectedSampleIds = Array.from(document.querySelectorAll('#sendTable tbody tr')).map(row => row.getAttribute('data-sample-id'));
            document.getElementById('selected-samples').value = selectedSampleIds.join(',');
        }
    
        // Función para añadir inputs ocultos al formulario de envío
        function addHiddenInput(sampleId) {
            const form = document.getElementById('send-form');
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selected_samples';
            input.value = sampleId;
            form.appendChild(input);
        }
    
        // Función para eliminar inputs ocultos del formulario de envío
        function removeHiddenInput(sampleId) {
            let inputToRemove = document.querySelector(`input[name="selected_samples"][value="${sampleId}"]`);
            if (inputToRemove) {
                inputToRemove.remove();
            }
        }
    
        // Eventos para botones en la tabla de selección de muestras
        document.querySelector('#samplesTable').addEventListener('click', function(event) {
            if (event.target.matches('.add-to-send')) {
                let sampleId = event.target.closest('tr').getAttribute('data-sample-id');
                moveRow(sampleId, 'sendTable', 'Volver a Subir', 'return-to-selection');
            }
        });
    
        // Eventos para botones en la tabla de muestras a enviar
        document.querySelector('#sendTable').addEventListener('click', function(event) {
            if (event.target.matches('.return-to-selection')) {
                let sampleId = event.target.closest('tr').getAttribute('data-sample-id');
                moveRow(sampleId, 'samplesTable', 'Agregar a Envíos', 'add-to-send');
            }
        });
    
        // Manejar el envío del formulario de envío
        document.getElementById('send-form').addEventListener('submit', function(event) {
            event.preventDefault();
            let selectedSamples = Array.from(document.querySelectorAll('#sendTable tbody tr')).map(row => row.getAttribute('data-sample-id'));
            if (selectedSamples.length === 0) {
                Swal.fire('Error', 'No se han seleccionado muestras para enviar.', 'error');
            } else {
                // Realizar la solicitud POST para registrar el envío
                let form = document.getElementById('send-form');
                let formData = new FormData(form);
                formData.append('selected_samples', selectedSamples.join(','));
    
                // Agregar console.log para depuración
                console.log('Enviando solicitud al servidor...');
                const dataToSend = {
                    sample_ids: selectedSamples // selectedSamples es un array de IDs de muestras seleccionadas
                };
                
                // Realizar la solicitud POST con los datos formateados como JSON
                fetch('/update-shipment/', {
                    method: 'POST',
                    body: JSON.stringify(dataToSend), // Convierte el objeto a una cadena JSON
                    headers: {
                        'X-CSRFToken': csrf_token,
                        'Content-Type': 'application/json', // Indica que estás enviando datos JSON
                    },
                })
                .then(response => response.json())
                .then(data => {
                    // Maneja la respuesta del servidor aquí
                    if (data.message) {
                        Swal.fire('Éxito', data.message, 'success')
                        .then((result) => {
                            if (result.isConfirmed || result.isDismissed) {
                                location.reload(); // Recarga la página
                            }
                        });
                    } else {
                        Swal.fire('Error', data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error en la solicitud:', error);
                });
            }
        });
    </script>
    
</body>
</html>
{% endblock %}